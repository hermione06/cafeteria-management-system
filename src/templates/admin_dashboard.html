{% extends "base.html" %}

{% block title %}Admin Dashboard - Bounty Cafeteria{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-header">
    <div class="gradient-box-admin">
        <h1 class="admin-title">admin</h1>
    </div>
    <p class="admin-subtitle">MANAGE YOUR CAFETERIA OPERATIONS</p>
</div>

<!-- Welcome Section -->
<div class="welcome-section">
    <h2 class="welcome-title">
        <i class="fas fa-shield-alt mr-3"></i> Admin Dashboard
    </h2>
    <p class="welcome-text">Manage your cafeteria operations</p>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="stats-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stats-label">Total Users</p>
                <p class="stats-value" id="totalUsers">0</p>
            </div>
            <div class="stats-icon icon-azure">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stats-label">Total Orders</p>
                <p class="stats-value" id="totalOrders">0</p>
            </div>
            <div class="stats-icon icon-green">
                <i class="fas fa-shopping-cart"></i>
            </div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stats-label">Menu Items</p>
                <p class="stats-value" id="totalMenuItems">0</p>
            </div>
            <div class="stats-icon icon-coral">
                <i class="fas fa-utensils"></i>
            </div>
        </div>
    </div>
    
    <div class="stats-card">
        <div class="flex items-center justify-between">
            <div>
                <p class="stats-label">Revenue</p>
                <p class="stats-value">₼<span id="totalRevenue">0</span></p>
            </div>
            <div class="stats-icon icon-yellow">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <button onclick="showSection('users')" class="action-btn action-users">
        <i class="fas fa-users"></i>
        <h3>Manage Users</h3>
    </button>
    
    <button onclick="showSection('menu')" class="action-btn action-menu">
        <i class="fas fa-utensils"></i>
        <h3>Manage Menu</h3>
    </button>
    
    <button onclick="showSection('orders')" class="action-btn action-orders">
        <i class="fas fa-shopping-cart"></i>
        <h3>Manage Orders</h3>
    </button>
    
    <button onclick="showSection('announcements')" class="action-btn action-announcements">
        <i class="fas fa-bullhorn"></i>
        <h3>Announcements</h3>
    </button>
</div>

<!-- Management Sections -->
<div id="usersSection" class="hidden management-section">
    <h2 class="section-title"><i class="fas fa-users mr-2"></i> User Management</h2>
    <div id="usersList"></div>
</div>

<div id="menuSection" class="hidden management-section">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-utensils mr-2"></i> Menu Management</h2>
        <button onclick="showAddMenuItem()" class="add-btn">
            <i class="fas fa-plus mr-2"></i> Add Item
        </button>
    </div>
    <div id="menuList"></div>
</div>

<div id="ordersSection" class="hidden management-section">
    <h2 class="section-title"><i class="fas fa-shopping-cart mr-2"></i> Order Management</h2>
    <div id="ordersList"></div>
</div>

<div id="announcementsSection" class="hidden management-section">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-bullhorn mr-2"></i> Announcements</h2>
        <button onclick="showAddAnnouncement()" class="add-btn">
            <i class="fas fa-plus mr-2"></i> New Announcement
        </button>
    </div>
    <div id="announcementsList"></div>
</div>

<!-- Recent Activity -->
<div class="management-section">
    <h2 class="section-title"><i class="fas fa-history mr-2"></i> Recent Orders</h2>
    <div id="recentOrders"></div>
</div>

<!-- Add Menu Item Modal -->
<div id="addMenuModal" class="hidden modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Menu Item</h2>
            <button onclick="closeAddMenuItem()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addMenuForm" class="modal-body">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" name="name" required class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" rows="3" class="form-textarea"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Price</label>
                <input type="number" name="price" step="0.01" required class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select name="category" required class="form-select">
                    <option value="beverages">Beverages</option>
                    <option value="food">Food</option>
                    <option value="snacks">Snacks</option>
                    <option value="desserts">Desserts</option>
                </select>
            </div>
            <button type="submit" class="submit-btn">
                <i class="fas fa-plus mr-2"></i> Add Item
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSection = null;
    
    // Load dashboard stats
    async function loadStats() {
        try {
            const [usersData, ordersData, menuData] = await Promise.all([
                apiRequest('/users/stats'),
                apiRequest('/orders'),
                apiRequest('/menu?available=false&per_page=1000')
            ]);
            
            document.getElementById('totalUsers').textContent = usersData.total_users || 0;
            document.getElementById('totalOrders').textContent = ordersData.orders?.length || 0;
            document.getElementById('totalMenuItems').textContent = menuData.items?.length || 0;
            
            const revenue = ordersData.orders?.reduce((sum, o) => sum + (o.total_price || 0), 0) || 0;
            document.getElementById('totalRevenue').textContent = revenue.toFixed(2);
            
            displayRecentOrders(ordersData.orders?.slice(0, 5) || []);
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    // Show section
    function showSection(section) {
        // Hide all sections
        ['users', 'menu', 'orders', 'announcements'].forEach(s => {
            document.getElementById(s + 'Section').classList.add('hidden');
        });
        
        // Show selected section
        document.getElementById(section + 'Section').classList.remove('hidden');
        currentSection = section;
        
        // Load section data
        switch(section) {
            case 'users':
                loadUsers();
                break;
            case 'menu':
                loadMenu();
                break;
            case 'orders':
                loadOrders();
                break;
            case 'announcements':
                loadAnnouncements();
                break;
        }
    }
    
    // Load users
    async function loadUsers() {
        try {
            const data = await apiRequest('/users');
            const container = document.getElementById('usersList');
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.users.map(user => `
                                <tr>
                                    <td style="font-weight: 700; color: #2D3748;">${user.username}</td>
                                    <td style="color: #4A5568;">${user.email}</td>
                                    <td style="color: #4A5568;">${user.role}</td>
                                    <td>${user.is_active ? '<span style="color: #48bb78;">✅ Active</span>' : '<span style="color: #e53e3e;">❌ Inactive</span>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    // Load menu items
    async function loadMenu() {
        try {
            const data = await apiRequest('/menu?available=false&per_page=1000');
            const container = document.getElementById('menuList');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${data.items.map(item => `
                        <div class="menu-item-card">
                            <h3 class="menu-item-title">${item.name}</h3>
                            <p style="color: #4A5568; font-size: 0.9rem; margin-bottom: 0.5rem;">${item.description || ''}</p>
                            <p class="menu-item-price">₼${item.price.toFixed(2)}</p>
                            <div class="flex justify-between items-center">
                                <span class="availability-badge ${item.is_available ? 'badge-available' : 'badge-unavailable'}">
                                    ${item.is_available ? '✅ Available' : '❌ Unavailable'}
                                </span>
                                <button onclick="toggleAvailability(${item.id}, ${!item.is_available})" class="toggle-btn">
                                    <i class="fas fa-toggle-${item.is_available ? 'on' : 'off'}"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            console.error('Error loading menu:', error);
        }
    }
    
    // Toggle menu item availability
    async function toggleAvailability(itemId, isAvailable) {
        try {
            await apiRequest(`/menu/${itemId}/availability`, {
                method: 'PATCH',
                body: JSON.stringify({ is_available: isAvailable })
            });
            showFlash('Item updated successfully', 'success');
            loadMenu();
        } catch (error) {
            console.error('Error toggling availability:', error);
        }
    }
    
    // Show/hide add menu item modal
    function showAddMenuItem() {
        document.getElementById('addMenuModal').classList.remove('hidden');
    }
    
    function closeAddMenuItem() {
        document.getElementById('addMenuModal').classList.add('hidden');
        document.getElementById('addMenuForm').reset();
    }
    
    // Handle add menu item form
    document.getElementById('addMenuForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            await apiRequest('/menu', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            showFlash('Menu item added successfully', 'success');
            closeAddMenuItem();
            loadMenu();
        } catch (error) {
            console.error('Error adding menu item:', error);
        }
    });
    
    // Load orders
    async function loadOrders() {
        try {
            const data = await apiRequest('/orders');
            const container = document.getElementById('ordersList');
            
            container.innerHTML = `
                <div class="space-y-4">
                    ${data.orders.slice(0, 10).map(order => `
                        <div class="order-card">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 style="font-weight: 700; font-size: 1.2rem; color: #2D3748;">Order #${order.id}</h3>
                                    <p style="font-size: 0.9rem; color: #4A5568;">${new Date(order.created_at).toLocaleString()}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-weight: 700; color: #4cb290; font-size: 1.3rem;">₼${order.total_price.toFixed(2)}</p>
                                    <p style="font-size: 0.9rem; color: #4A5568;">${order.status}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            console.error('Error loading orders:', error);
        }
    }
    
    // Load announcements
    async function loadAnnouncements() {
        try {
            const data = await apiRequest('/announcements/all');
            const container = document.getElementById('announcementsList');
            
            container.innerHTML = `
                <div class="space-y-4">
                    ${data.announcements.map(ann => `
                        <div class="announcement-card">
                            <h3 class="announcement-title">${ann.title}</h3>
                            <p style="color: #4A5568; margin-top: 0.5rem;">${ann.message}</p>
                            <p style="font-size: 0.9rem; color: #4A5568; margin-top: 0.5rem;">Priority: ${ann.priority}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            console.error('Error loading announcements:', error);
        }
    }
    
    function showAddAnnouncement() {
        showFlash('Feature coming soon!', 'info');
    }
    
    // Display recent orders
    function displayRecentOrders(orders) {
        const container = document.getElementById('recentOrders');
        
        if (orders.length === 0) {
            container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 2rem;">No recent orders</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="space-y-3">
                ${orders.map(order => `
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem;">
                        <div>
                            <p style="font-weight: 700; color: #2D3748;">Order #${order.id}</p>
                            <p style="font-size: 0.9rem; color: #4A5568;">${order.items.length} items</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-weight: 700; color: #4cb290;">₼${order.total_price.toFixed(2)}</p>
                            <p style="font-size: 0.8rem; color: #4A5568;">${order.status}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // Load stats on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        setInterval(loadStats, 30000); // Refresh every 30 seconds
    });
</script>
{% endblock %}