{% extends "base.html" %}

{% block title %}Menu - Bounty Cafeteria{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/menu.css') }}">
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="menu-header">
    <div class="gradient-box-menu">
        <h1 class="menu-title">menu</h1>
    </div>
    <p class="menu-subtitle">BROWSE OUR DELICIOUS SELECTION</p>
</div>

<!-- Filters & Search -->
<div class="filter-section">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Search -->
        <div class="md:col-span-2">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Search menu items..."
                    class="filter-input w-full pl-12"
                    oninput="loadMenu()"
                >
            </div>
        </div>
        
        <!-- Category Filter -->
        <div>
            <select 
                id="categoryFilter"
                class="filter-select w-full"
                onchange="loadMenu()"
            >
                <option value="">All Categories</option>
                <option value="beverages">Beverages</option>
                <option value="food">Food</option>
                <option value="snacks">Snacks</option>
                <option value="desserts">Desserts</option>
            </select>
        </div>
        
        <!-- Availability Filter -->
        <div>
            <select 
                id="availabilityFilter"
                class="filter-select w-full"
                onchange="loadMenu()"
            >
                <option value="true">Available Only</option>
                <option value="false">All Items</option>
            </select>
        </div>
    </div>
</div>

<!-- Shopping Cart Summary -->
<div id="cartSummary" class="cart-summary hidden" onclick="toggleCart()">
    <i class="fas fa-shopping-cart mr-2"></i>
    <span id="cartCount">0</span> items - ₼<span id="cartTotal">0.00</span>
</div>

<!-- Menu Items Grid -->
<div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
    <!-- Items will be loaded via JavaScript -->
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="loading-spinner">
    <i class="fas fa-spinner spinner-icon"></i>
    <p style="font-family: 'Fredoka', sans-serif; color: #4A5568; font-weight: 600; margin-top: 1rem;">Loading menu...</p>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="cart-modal hidden">
    <div class="cart-modal-content">
        <!-- Modal Header -->
        <div class="cart-modal-header">
            <h2 class="cart-modal-title">
                <i class="fas fa-shopping-cart mr-2"></i> Your Cart
            </h2>
            <button onclick="toggleCart()" class="cart-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Cart Items -->
        <div id="cartItems" class="cart-items-container">
            <!-- Cart items will be loaded here -->
        </div>
        
        <!-- Cart Footer -->
        <div class="cart-footer">
            <div class="flex justify-between items-center mb-4">
                <span style="font-size: 1.5rem; font-weight: 700; color: #2D3748;">Total:</span>
                <span style="font-size: 2rem; font-weight: 700; color: #4cb290;">₼<span id="modalCartTotal">0.00</span></span>
            </div>
            <button onclick="checkout()" class="checkout-btn">
                <i class="fas fa-check mr-2"></i> Proceed to Checkout
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let menuItems = [];
    
    // Load menu items
    async function loadMenu() {
        const searchQuery = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const available = document.getElementById('availabilityFilter').value;
        
        const params = new URLSearchParams({
            available: available,
            ...(category && { category }),
            ...(searchQuery && { search: searchQuery })
        });
        
        try {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('menuGrid').innerHTML = '';
            
            const response = await fetch(`${API_BASE}/menu?${params}`);
            const data = await response.json();
            
            menuItems = data.items;
            displayMenuItems(menuItems);
        } catch (error) {
            console.error('Error loading menu:', error);
            showFlash('Failed to load menu', 'error');
        } finally {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
    }
    
    // Display menu items
    function displayMenuItems(items) {
        const grid = document.getElementById('menuGrid');
        
        if (items.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full empty-state">
                    <i class="fas fa-utensils"></i>
                    <p style="font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: 600;">No items found</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = items.map(item => `
            <div class="menu-card">
                <div class="menu-card-image">
                    ${item.image_url ? 
                        `<img src="${item.image_url}" alt="${item.name}" class="w-full h-full object-cover">` :
                        `<i class="fas fa-utensils text-6xl text-white"></i>`
                    }
                </div>
                <div class="menu-card-content">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="menu-card-title">${item.name}</h3>
                        ${item.is_available ? 
                            `<span class="available-badge badge-available">
                                <i class="fas fa-check-circle"></i> Available
                            </span>` :
                            `<span class="available-badge badge-unavailable">
                                <i class="fas fa-times-circle"></i> Out
                            </span>`
                        }
                    </div>
                    <p class="menu-card-description">${item.description || 'Delicious and fresh'}</p>
                    <div class="flex justify-between items-center mt-4">
                        <span class="menu-card-price">₼${item.price.toFixed(2)}</span>
                        ${item.is_available ? 
                            `<button 
                                onclick="addToCart(${item.id})"
                                class="add-to-cart-btn"
                            >
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>` :
                            `<button 
                                disabled
                                class="add-to-cart-btn"
                            >
                                Unavailable
                            </button>`
                        }
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Add item to cart
    function addToCart(itemId) {
        const item = menuItems.find(i => i.id === itemId);
        if (!item) return;
        
        const existingItem = cart.find(i => i.id === itemId);
        
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...item, quantity: 1 });
        }
        
        updateCartDisplay();
        showFlash(`${item.name} added to cart`, 'success');
    }
    
    // Update cart display
    function updateCartDisplay() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        document.getElementById('cartCount').textContent = totalItems;
        document.getElementById('cartTotal').textContent = totalPrice.toFixed(2);
        document.getElementById('modalCartTotal').textContent = totalPrice.toFixed(2);
        
        if (totalItems > 0) {
            document.getElementById('cartSummary').classList.remove('hidden');
        } else {
            document.getElementById('cartSummary').classList.add('hidden');
        }
        
        displayCartItems();
    }
    
    // Display cart items
    function displayCartItems() {
        const container = document.getElementById('cartItems');
        
        if (cart.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <p style="font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: 600;">Your cart is empty</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = cart.map(item => `
            <div class="cart-item">
                <div style="flex: 1;">
                    <h4 style="font-weight: 700; color: #2D3748; font-size: 1.1rem;">${item.name}</h4>
                    <p style="color: #4A5568; font-size: 0.9rem;">₼${item.price.toFixed(2)} each</p>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="cart-quantity-controls">
                        <button onclick="updateQuantity(${item.id}, -1)" class="cart-quantity-btn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span style="font-weight: 700; min-width: 2rem; text-align: center;">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" class="cart-quantity-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <span style="font-weight: 700; color: #4cb290; min-width: 5rem; text-align: right;">₼${(item.price * item.quantity).toFixed(2)}</span>
                    <button onclick="removeFromCart(${item.id})" style="color: #e53e3e; background: none; border: none; cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    // Update quantity
    function updateQuantity(itemId, change) {
        const item = cart.find(i => i.id === itemId);
        if (!item) return;
        
        item.quantity += change;
        
        if (item.quantity <= 0) {
            removeFromCart(itemId);
        } else {
            updateCartDisplay();
        }
    }
    
    // Remove from cart
    function removeFromCart(itemId) {
        cart = cart.filter(i => i.id !== itemId);
        updateCartDisplay();
        showFlash('Item removed from cart', 'info');
    }
    
    // Toggle cart modal
    function toggleCart() {
        document.getElementById('cartModal').classList.toggle('hidden');
    }
    
    // Checkout
    async function checkout() {
        if (cart.length === 0) {
            showFlash('Your cart is empty', 'error');
            return;
        }
        
        const token = getToken();
        if (!token) {
            showFlash('Please login to place an order', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
            return;
        }
        
        try {
            const orderItems = cart.map(item => ({
                menu_item_id: item.id,
                quantity: item.quantity
            }));
            
            const response = await apiRequest('/orders', {
                method: 'POST',
                body: JSON.stringify({ items: orderItems })
            });
            
            showFlash('Order placed successfully!', 'success');
            cart = [];
            updateCartDisplay();
            toggleCart();
            
            setTimeout(() => {
                window.location.href = '/orders';
            }, 1500);
        } catch (error) {
            console.error('Checkout error:', error);
        }
    }
    
    // Load menu on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadMenu();
    });
</script>
{% endblock %}