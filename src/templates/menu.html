{% extends "base.html" %}

{% block title %}Menu - CafeHub{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">
        <i class="fas fa-book-open mr-3"></i> Our Menu
    </h1>
    <p class="text-gray-600">Browse our delicious selection of food and beverages</p>
</div>

<!-- Filters & Search -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Search -->
        <div class="md:col-span-2">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Search menu items..."
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    oninput="loadMenu()"
                >
            </div>
        </div>
        
        <!-- Category Filter -->
        <div>
            <select 
                id="categoryFilter"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                onchange="loadMenu()"
            >
                <option value="">All Categories</option>
                <option value="beverages">Beverages</option>
                <option value="food">Food</option>
                <option value="snacks">Snacks</option>
                <option value="desserts">Desserts</option>
            </select>
        </div>
        
        <!-- Availability Filter -->
        <div>
            <select 
                id="availabilityFilter"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                onchange="loadMenu()"
            >
                <option value="true">Available Only</option>
                <option value="false">All Items</option>
            </select>
        </div>
    </div>
</div>

<!-- Shopping Cart Summary -->
<div id="cartSummary" class="hidden fixed bottom-4 right-4 bg-primary text-white px-6 py-4 rounded-full shadow-2xl cursor-pointer hover:bg-blue-600 transition transform hover:scale-105 z-50" onclick="toggleCart()">
    <i class="fas fa-shopping-cart mr-2"></i>
    <span id="cartCount">0</span> items - $<span id="cartTotal">0.00</span>
</div>

<!-- Menu Items Grid -->
<div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
    <!-- Items will be loaded via JavaScript -->
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center py-12">
    <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
    <p class="text-gray-600 mt-4">Loading menu...</p>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="gradient-bg p-6 text-white flex justify-between items-center">
            <h2 class="text-2xl font-bold">
                <i class="fas fa-shopping-cart mr-2"></i> Your Cart
            </h2>
            <button onclick="toggleCart()" class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Cart Items -->
        <div id="cartItems" class="p-6 max-h-96 overflow-y-auto">
            <!-- Cart items will be loaded here -->
        </div>
        
        <!-- Cart Footer -->
        <div class="border-t p-6">
            <div class="flex justify-between items-center mb-4">
                <span class="text-xl font-bold text-gray-800">Total:</span>
                <span class="text-2xl font-bold text-primary">$<span id="modalCartTotal">0.00</span></span>
            </div>
            <button 
                onclick="checkout()"
                class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition"
            >
                <i class="fas fa-check mr-2"></i> Proceed to Checkout
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let menuItems = [];
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load menu items
    async function loadMenu() {
        const searchQuery = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const available = document.getElementById('availabilityFilter').value;
        
        const params = new URLSearchParams({
            available: available
        });
        
        if (category) {
            params.append('category', category);
        }
        
        if (searchQuery) {
            params.append('search', searchQuery);
        }
        
        try {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('menuGrid').innerHTML = '';
            
            // Updated API endpoint from /menu to match Flask blueprint
            const response = await fetch(`/api/menu?${params}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            menuItems = data.items || [];
            displayMenuItems(menuItems);
        } catch (error) {
            console.error('Error loading menu:', error);
            document.getElementById('menuGrid').innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <p class="text-xl text-red-500">Failed to load menu. Please try again later.</p>
                </div>
            `;
        } finally {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
    }
    
    // Display menu items
    function displayMenuItems(items) {
        const grid = document.getElementById('menuGrid');
        
        if (items.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-utensils text-6xl text-gray-300 mb-4"></i>
                    <p class="text-xl text-gray-500">No items found</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = items.map(item => `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition transform hover:-translate-y-2 fade-in">
                <div class="h-48 bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
                    ${item.image_url ? 
                        `<img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.name)}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-utensils text-6xl text-white\\'></i>'">` :
                        `<i class="fas fa-utensils text-6xl text-white"></i>`
                    }
                </div>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-gray-800">${escapeHtml(item.name)}</h3>
                        ${item.is_available ? 
                            `<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">
                                <i class="fas fa-check-circle"></i>
                            </span>` :
                            `<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">
                                <i class="fas fa-times-circle"></i>
                            </span>`
                        }
                    </div>
                    ${item.category ? `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs mb-2">${escapeHtml(item.category)}</span>` : ''}
                    <p class="text-gray-600 text-sm mb-4">${escapeHtml(item.description || 'Delicious and fresh')}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-2xl font-bold text-primary">$${parseFloat(item.price).toFixed(2)}</span>
                        ${item.is_available ? 
                            `<button 
                                onclick="addToCart(${item.id})"
                                class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
                            >
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>` :
                            `<button 
                                disabled
                                class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg cursor-not-allowed"
                            >
                                Unavailable
                            </button>`
                        }
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Add item to cart
    function addToCart(itemId) {
        const item = menuItems.find(i => i.id === itemId);
        if (!item) return;
        
        const existingItem = cart.find(i => i.id === itemId);
        
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...item, quantity: 1 });
        }
        
        updateCartDisplay();
        showNotification(`${item.name} added to cart`, 'success');
    }
    
    // Show notification (simple implementation)
    function showNotification(message, type) {
        // You can replace this with a more sophisticated notification system
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-error' : 'alert-info';
        console.log(`${type.toUpperCase()}: ${message}`);
        // If you have a showAlert function, use it instead
        if (typeof showAlert === 'function') {
            showAlert(message, type);
        }
    }
    
    // Update cart display
    function updateCartDisplay() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        document.getElementById('cartCount').textContent = totalItems;
        document.getElementById('cartTotal').textContent = totalPrice.toFixed(2);
        document.getElementById('modalCartTotal').textContent = totalPrice.toFixed(2);
        
        if (totalItems > 0) {
            document.getElementById('cartSummary').classList.remove('hidden');
        } else {
            document.getElementById('cartSummary').classList.add('hidden');
        }
        
        displayCartItems();
    }
    
    // Display cart items
    function displayCartItems() {
        const container = document.getElementById('cartItems');
        
        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Your cart is empty</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = cart.map(item => `
            <div class="flex items-center justify-between border-b py-4">
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800">${escapeHtml(item.name)}</h4>
                    <p class="text-sm text-gray-600">$${parseFloat(item.price).toFixed(2)} each</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-gray-100 rounded-lg px-3 py-1">
                        <button onclick="updateQuantity(${item.id}, -1)" class="text-gray-600 hover:text-primary">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-bold w-8 text-center">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" class="text-gray-600 hover:text-primary">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <span class="font-bold text-primary w-20 text-right">$${(item.price * item.quantity).toFixed(2)}</span>
                    <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    // Update quantity
    function updateQuantity(itemId, change) {
        const item = cart.find(i => i.id === itemId);
        if (!item) return;
        
        item.quantity += change;
        
        if (item.quantity <= 0) {
            removeFromCart(itemId);
        } else {
            updateCartDisplay();
        }
    }
    
    // Remove from cart
    function removeFromCart(itemId) {
        cart = cart.filter(i => i.id !== itemId);
        updateCartDisplay();
        showNotification('Item removed from cart', 'info');
    }
    
    // Toggle cart modal
    function toggleCart() {
        document.getElementById('cartModal').classList.toggle('hidden');
    }
    
    // Get JWT token
    function getToken() {
        return localStorage.getItem('token');
    }
    
    // Checkout
    async function checkout() {
        if (cart.length === 0) {
            showNotification('Your cart is empty', 'error');
            return;
        }
        
        const token = getToken();
        if (!token) {
            showNotification('Please login to place an order', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
            return;
        }
        
        try {
            const orderItems = cart.map(item => ({
                menu_item_id: item.id,
                quantity: item.quantity
            }));
            
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ items: orderItems })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to place order');
            }
            
            showNotification('Order placed successfully!', 'success');
            cart = [];
            updateCartDisplay();
            toggleCart();
            
            setTimeout(() => {
                window.location.href = '/orders';
            }, 1500);
        } catch (error) {
            console.error('Checkout error:', error);
            showNotification(error.message || 'Failed to place order', 'error');
        }
    }
    
    // Load menu on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadMenu();
    });
</script>
{% endblock %}