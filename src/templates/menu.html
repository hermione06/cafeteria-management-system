{% extends "base.html" %}

{% block title %}Menu - Cafeteria{% endblock %}

{% block content %}
<div style="padding: 2rem;">
  <h1 style="color: var(--bounty-blue); text-align: center; margin-bottom: 2rem;">Our Menu</h1>
  
  <!-- Filter Options -->
  <div style="text-align: center; margin-bottom: 2rem;">
    <button class="btn" onclick="filterMenu('all')" id="filter-all">All Items</button>
    <button class="btn" onclick="filterMenu('available')" id="filter-available">Available Only</button>
  </div>
  
  <!-- Menu Items Container -->
  <div class="card-container" id="menu-container">
    <p style="text-align: center; width: 100%;">Loading menu...</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let allDishes = [];
  let currentFilter = 'all';
  
  // Fetch menu from backend
  async function loadMenu() {
    try {
      const response = await fetch('/menu');
      const data = await response.json();
      allDishes = data.dishes || [];
      renderMenu();
    } catch (error) {
      console.error('Error loading menu:', error);
      document.getElementById('menu-container').innerHTML = 
        '<p style="text-align: center; width: 100%; color: #888;">Unable to load menu. Please try again later.</p>';
    }
  }
  
  // Render menu items based on current filter
  function renderMenu() {
    const container = document.getElementById('menu-container');
    
    let filteredDishes = allDishes;
    if (currentFilter === 'available') {
      filteredDishes = allDishes.filter(dish => dish.is_available);
    }
    
    if (filteredDishes.length === 0) {
      container.innerHTML = '<p style="text-align: center; width: 100%; color: #888;">No dishes found.</p>';
      return;
    }
    
    container.innerHTML = filteredDishes.map(dish => `
      <div class="card">
        <img src="${dish.picture_link || '/static/images/placeholder.jpg'}" 
             alt="${dish.name}" 
             style="width: 100%; height: 180px; object-fit: cover; border-radius: var(--radius); margin-bottom: 1rem;">
        
        <h3 style="color: var(--bounty-blue); margin-bottom: 0.5rem;">${dish.name}</h3>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">${dish.description}</p>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 1.2rem; font-weight: bold; color: var(--bounty-brown);">$${dish.price.toFixed(2)}</span>
          <span style="font-size: 0.85rem; color: ${dish.is_available ? '#28a745' : '#dc3545'};">
            ${dish.is_available ? '✓ Available' : '✗ Unavailable'}
          </span>
        </div>
        
        ${dish.is_available ? `
          <button class="btn" style="width: 100%; margin-top: 1rem;" onclick="addToCart(${dish.dish_id})">
            Add to Cart
          </button>
        ` : ''}
        
        <a href="/menu/${dish.dish_id}" style="display: block; text-align: center; margin-top: 0.5rem; color: var(--bounty-blue); text-decoration: none;">
          View Details & Ratings
        </a>
      </div>
    `).join('');
  }
  
  // Filter menu items
  function filterMenu(filter) {
    currentFilter = filter;
    renderMenu();
    
    // Update button styles
    document.getElementById('filter-all').style.opacity = filter === 'all' ? '1' : '0.6';
    document.getElementById('filter-available').style.opacity = filter === 'available' ? '1' : '0.6';
  }
  
  // Add item to cart (stores in sessionStorage)
  function addToCart(dishId) {
    const dish = allDishes.find(d => d.dish_id === dishId);
    if (!dish) return;
    
    // Get existing cart from sessionStorage
    let cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
    
    // Check if item already exists in cart
    const existingItem = cart.find(item => item.dish_id === dishId);
    if (existingItem) {
      existingItem.count++;
    } else {
      cart.push({ ...dish, count: 1 });
    }
    
    // Save back to sessionStorage
    sessionStorage.setItem('cart', JSON.stringify(cart));
    
    // Show feedback
    alert(`${dish.name} added to cart!`);
  }
  
  // Load menu on page load
  document.addEventListener('DOMContentLoaded', loadMenu);
</script>
{% endblock %}